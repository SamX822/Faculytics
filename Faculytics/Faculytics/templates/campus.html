{% extends "layout.html" %}
{% set title = campus.campus_name %}

{% block content %}
<div class="flex">
    {% include "sidebar.html" %}
    <main class="ml-[260px] p-6 mt-[60px] text-gray-300">
        <h2 class="text-3xl font-bold text-white mb-4">{{ campus.campus_name }}</h2>
        <a href="{{ url_for('dashboard') }}" class="mb-4 inline-block px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
            Back to Dashboard
        </a>

        <!-- Manage Colleges Button -->
        {% if user.userType in ['Campus Director', 'Vice Chancellor'] %}
        <button id="manage-colleges-btn" class="mb-4 inline-block px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-white">
            Manage Colleges
        </button>
        {% endif %}

        <!-- Add College Form (Hidden by default) -->
        <div id="add-college-form" style="display:none;">
            <h3 class="text-2xl font-bold text-white mb-4 mt-6">Add a New College</h3>
            <form action="{{ url_for('add_college', campus_acronym=campus.campus_acronym) }}" method="POST">
                <input type="text" name="college_name" placeholder="Enter College Name" required class="w-full p-3 bg-gray-700 text-white rounded-lg mb-4" />
                <input type="text" name="college_acronym" placeholder="Enter College Acronym" required class="w-full p-3 bg-gray-700 text-white rounded-lg mb-4" />
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg">Add College</button>
            </form>
        </div>

        <!-- Remove College Form (Hidden by default) -->
        <div id="remove-college-form" style="display:none;">
            <h3 class="text-2xl font-bold text-white mb-4 mt-6">Remove a College</h3>
            <form action="{{ url_for('remove_college', campus_acronym=campus.campus_acronym) }}" method="POST">
                <select name="college_to_remove" class="w-full p-3 bg-gray-700 text-white rounded-lg mb-4">
                    {% for college in campus.colleges %}
                    <option value="{{ college.college_name }}">{{ college.college_name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg">Remove College</button>
            </form>
        </div>

        <div class="grid grid-cols-2 gap-6 justify-items-center">
            {% if user.userType == "Curriculum Developer" %}
            <!-- Show all colleges for Curriculum Developers -->
            {% for college in campus.colleges %}
            <div class="college-card bg-gray-800 p-4 rounded-lg shadow-md flex flex-col items-center transition hover:bg-gray-700 cursor-pointer"
                 onclick="toggleCollegeActions('{{ college.college_acronym }}')">
                <div class="w-20 h-20 bg-white rounded-full mb-4"></div>
                <p class="text-white text-lg font-bold text-center">{{ college.college_name }}</p>
                <div id="actions-{{ college.college_acronym }}" class="hidden mt-4 flex gap-2">
                    <a href="{{ url_for('college_page', college_acronym=college.college_acronym, campus_acronym=campus.campus_acronym) }}"
                       class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                        Enter
                    </a>
                    <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg"
                            onclick="openCollegeAnalysisModal(event, '{{ college.college_acronym }}')">
                        Analytics
                    </button>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <!-- for other user types -->
            {% if visible_colleges %}
            {% for college in visible_colleges %}
            <div class="college-card bg-gray-800 p-4 rounded-lg shadow-md flex flex-col items-center transition hover:bg-gray-700 cursor-pointer"
                 onclick="toggleCollegeActions('{{ college.college_acronym }}')">
                <div class="w-20 h-20 bg-white rounded-full mb-4"></div>
                <p class="text-white text-lg font-bold text-center">{{ college.college_name }}</p>
                <div id="actions-{{ college.college_acronym }}" class="hidden mt-4 flex gap-2">
                    <a href="{{ url_for('college_page', college_acronym=college.college_acronym, campus_acronym=campus.campus_acronym) }}"
                       class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                        Enter
                    </a>
                    <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg"
                            onclick="openCollegeAnalysisModal(event, '{{ college.college_acronym }}')">
                        Analytics
                    </button>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-gray-400 col-span-2">No colleges found or you are unauthorized to access them.</p>
            {% endif %}
            {% endif %}
        </div>

        <!-- College Analysis Modal with Tabs -->
        <div id="collegeAnalysisModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4">
            <div class="bg-gray-800 p-6 rounded-lg w-full max-w-3xl mt-4 overflow-y-auto max-h-[90vh]">
                <h3 class="text-xl font-bold text-white mb-4">College-Wide Analytics</h3>

                <!-- Tabs Navigation -->
                <div class="flex border-b border-gray-700 mb-4">
                    <button id="collegeSentimentTab" class="py-2 px-4 text-white bg-blue-600 rounded-t-lg mr-2">Sentiment Analysis</button>
                    <button id="collegeTopicTab" class="py-2 px-4 text-white bg-gray-700 rounded-t-lg">Topic Modeling</button>
                </div>

                <!-- Tab Content -->
                <div id="collegeSentimentContent" class="block">
                    <canvas id="collegeAnalysisChart"></canvas>
                </div>
                <div id="collegeTopicContent" class="hidden">
                    <canvas id="collegeTopicChart" width="400" height="200"></canvas>
                </div>

                <!-- Details -->
                <div id="collegeDetails" class="mt-4 text-white"></div>

                <!-- Actions -->
                <div class="mt-4 flex justify-between">
                    <button onclick="closeCollegeAnalysisModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg">Close</button>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let collegeChartInstance = null;
    let collegeTopicChartInstance = null;

    // College Modal Tab Logic
    document.getElementById('collegeSentimentTab').addEventListener('click', function () {
        console.log("Sentiment tab clicked");

        // Show Sentiment content and hide Topic content
        document.getElementById('collegeSentimentContent').classList.remove('hidden');
        document.getElementById('collegeTopicContent').classList.add('hidden');

        // Update button styles for active tab
        this.classList.add('bg-blue-600');
        this.classList.remove('bg-gray-700');

        document.getElementById('collegeTopicTab').classList.remove('bg-blue-600');
        document.getElementById('collegeTopicTab').classList.add('bg-gray-700');
    });

    document.getElementById('collegeTopicTab').addEventListener('click', function () {
        console.log("Topic tab clicked");

        // Show Topic content and hide Sentiment content
        document.getElementById('collegeSentimentContent').classList.add('hidden');
        document.getElementById('collegeTopicContent').classList.remove('hidden');

        // Update button styles for active tab
        this.classList.add('bg-blue-600');
        this.classList.remove('bg-gray-700');

        document.getElementById('collegeSentimentTab').classList.remove('bg-blue-600');
        document.getElementById('collegeSentimentTab').classList.add('bg-gray-700');
    });

    document.getElementById('manage-colleges-btn').addEventListener('click', function () {
        const addForm = document.getElementById('add-college-form');
        const removeForm = document.getElementById('remove-college-form');

        if (addForm.style.display === 'none') {
            addForm.style.display = 'block';
            removeForm.style.display = 'block';
        } else {
            addForm.style.display = 'none';
            removeForm.style.display = 'none';
        }
    });

    function toggleCollegeActions(collegeAcronym) {
        document.querySelectorAll('[id^="actions-"]').forEach(el => el.classList.add('hidden'));
        const actions = document.getElementById('actions-' + collegeAcronym);
        actions.classList.toggle('hidden');
    }

    function openCollegeAnalysisModal(event, collegeAcronym) {
        event.stopPropagation();
        document.getElementById('collegeAnalysisModal').classList.remove('hidden');

        // Default to Sentiment tab
        document.getElementById('collegeSentimentTab').click();

        fetch(`/college_analysis?college_acronym=${encodeURIComponent(collegeAcronym)}&include_topics=true`)
            .then(response => response.json())
            .then(data => {
                console.log("College Analysis Data:", data);

                if (data.error) {
                    document.getElementById('collegeDetails').innerHTML = `<p class="text-red-500">${data.error}</p>`;
                    return;
                }

                // ---------- SENTIMENT CHART ----------
                const sentimentCtx = document.getElementById('collegeAnalysisChart').getContext('2d');
                if (collegeChartInstance) {
                    collegeChartInstance.destroy();
                }

                const groupedSentiments = {};
                data.files.forEach(file => {
                    const filename = file.filename;
                    const sentiments = Array.isArray(file.sentiment)
                        ? file.sentiment
                        : JSON.parse(file.sentiment || "[]");

                    if (!groupedSentiments[filename]) {
                        groupedSentiments[filename] = { positive: 0, negative: 0 };
                    }

                    sentiments.forEach(s => {
                        if (s === "Positive") groupedSentiments[filename].positive++;
                        else if (s === "Negative") groupedSentiments[filename].negative++;
                    });
                });

                function parseFilename(filename) {
                    const [startYear, endYear, semester] = filename.split('_').map(Number);
                    return { startYear, endYear, semester };
                }

                const sortedFilenames = Object.keys(groupedSentiments).sort((a, b) => {
                    const aParts = parseFilename(a);
                    const bParts = parseFilename(b);
                    if (aParts.startYear !== bParts.startYear) return aParts.startYear - bParts.startYear;
                    if (aParts.endYear !== bParts.endYear) return aParts.endYear - bParts.endYear;
                    return aParts.semester - bParts.semester;
                });

                const labels = sortedFilenames;
                positiveData = sortedFilenames.map(filename => groupedSentiments[filename].positive);
                negativeData = sortedFilenames.map(filename => groupedSentiments[filename].negative);

                collegeChartInstance = new Chart(sentimentCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Positive',
                                data: positiveData,
                                borderColor: 'green',
                                fill: false,
                                pointStyle: 'circle',
                                pointRadius: 5
                            },
                            {
                                label: 'Negative',
                                data: negativeData,
                                borderColor: 'red',
                                fill: false,
                                pointStyle: 'circle',
                                pointRadius: 5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'College Sentiment Trends',
                                color: 'white'
                            },
                            legend: {
                                labels: {
                                    color: 'white'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (tooltipItem) {
                                        return `${tooltipItem.dataset.label}: ${tooltipItem.raw} sentiments`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Files',
                                    color: 'white'
                                },
                                ticks: {
                                    color: 'white'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Sentiment Count',
                                    color: 'white'
                                },
                                ticks: {
                                    color: 'white'
                                }
                            }
                        }
                    }
                });

                // ---------- TOPIC CHART ----------
                const topicCtx = document.getElementById('collegeTopicChart').getContext('2d');
                if (collegeTopicChartInstance) {
                    collegeTopicChartInstance.destroy();
                }

                const topicCounts = {};
                const topicSentiments = {};

                // Count the topics and their sentiments (positive/negative)
                data.files.forEach(file => {
                    const topics = Array.isArray(file.topics) ? file.topics : JSON.parse(file.topics || "[]");
                    const sentiments = Array.isArray(file.sentiment) ? file.sentiment : JSON.parse(file.sentiment || "[]");

                    topics.forEach((topic, index) => {
                        if (!topic || topic.trim() === "") return;

                        // Initialize topic count and sentiment data
                        if (!topicCounts[topic]) {
                            topicCounts[topic] = 0;
                            topicSentiments[topic] = { positive: 0, negative: 0 };
                        }

                        topicCounts[topic]++;

                        // Map sentiment to the corresponding topic
                        if (index < sentiments.length) {
                            if (sentiments[index] === "Positive") {
                                topicSentiments[topic].positive++;
                            } else {
                                topicSentiments[topic].negative++;
                            }
                        } else {
                            console.warn(`Mismatched sentiment for topic: "${topic}" at index ${index}`);
                        }
                    });
                });

                console.log("All Topic Counts:", topicCounts);
                console.log("All Topic Sentiments:", topicSentiments);

                // Sort topics by frequency and get top 10
                const topTopics = Object.keys(topicCounts)
                    .sort((a, b) => topicCounts[b] - topicCounts[a])
                    .slice(0, 10);

                // Build positive and negative data arrays aligned with topTopics
                positiveData = topTopics.map(topic => topicSentiments[topic]?.positive || 0);
                negativeData = topTopics.map(topic => topicSentiments[topic]?.negative || 0);

                collegeTopicChartInstance = new Chart(topicCtx, {
                    type: 'bar',
                    data: {
                        labels: topTopics,
                        datasets: [
                            {
                                label: 'Positive',
                                data: positiveData,
                                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                                borderColor: 'rgba(40, 167, 69, 1)',
                                borderWidth: 1,
                                categoryPercentage: 0.8,
                                barPercentage: 0.4
                            },
                            {
                                label: 'Negative',
                                data: negativeData,
                                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                                borderColor: 'rgba(220, 53, 69, 1)',
                                borderWidth: 1,
                                categoryPercentage: 0.8,
                                barPercentage: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Count',
                                    color: 'white'
                                },
                                ticks: {
                                    stepSize: 1,
                                    color: 'white'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Topics',
                                    color: 'white'
                                },
                                ticks: {
                                    color: 'white'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: 'white'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (tooltipItem) {
                                        return `${tooltipItem.dataset.label}: ${tooltipItem.raw} comments`;
                                    }
                                }
                            }
                        }
                    }
                });

                // ---------- DETAILS ----------
                document.getElementById('collegeDetails').innerHTML = `<p>Recommendation: ${data.recommendation}</p>`;
            })
            .catch(error => {
                console.error("Error fetching college analysis data:", error);
                document.getElementById('collegeDetails').innerHTML = `<p class="text-red-500">Failed to load analysis data.</p>`;
            });
    }

    function closeCollegeAnalysisModal() {
        document.getElementById('collegeAnalysisModal').classList.add('hidden');
    }
</script>
{% endblock %}