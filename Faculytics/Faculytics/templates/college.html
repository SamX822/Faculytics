{% extends "layout.html" %}
{% set title = college.college_acronym %}

{% block content %}
<div class="flex">
    {% include "sidebar.html" %}
    <main class="ml-[260px] p-6 mt-[60px] text-gray-300">
        <h2 class="text-3xl font-bold text-white mb-4">{{ college.college_name }}</h2>
        <a href="{{ url_for('campus_page', campus_acronym=campus.campus_acronym) }}"
           class="mb-4 inline-block px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white">
            Back to Campus
        </a>

        {% if user.userType == 'admin' %}
        <!-- Admin View: Display grids for various user roles -->
        <h3 class="text-2xl font-bold text-white mb-4">Campus Directors</h3>
        <div class="grid grid-cols-2 gap-6">
            {% set directors = users | selectattr("userType", "equalto", "Campus Director") | list %}
            {% if directors %}
            {% for director in directors %}
            <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center transition hover:bg-gray-700 cursor-pointer"
                 onclick="confirmDeleteUser({{ director.id }})">
                <div class="w-20 h-20 bg-white rounded-full mb-4"></div>
                <p class="text-white text-lg font-bold text-center">{{ director.firstName }} {{ director.lastName }}</p>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-gray-400 col-span-2">No Campus Directors found for this college.</p>
            {% endif %}
        </div>

        <h3 class="text-2xl font-bold text-white mb-4">Vice Chancellors</h3>
        <div class="grid grid-cols-2 gap-6">
            {% set chancellors = users | selectattr("userType", "equalto", "Vice Chancellor") | list %}
            {% if chancellors %}
            {% for chancellor in chancellors %}
            <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center transition hover:bg-gray-700 cursor-pointer"
                 onclick="confirmDeleteUser({{ chancellor.id }})">
                <div class="w-20 h-20 bg-white rounded-full mb-4"></div>
                <p class="text-white text-lg font-bold text-center">{{ chancellor.firstName }} {{ chancellor.lastName }}</p>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-gray-400 col-span-2">No Vice Chancellors found for this college.</p>
            {% endif %}
        </div>

        <h3 class="text-2xl font-bold text-white mb-4">Deans</h3>
        <div class="grid grid-cols-2 gap-6">
            {% set deans = users | selectattr("userType", "equalto", "Dean") | list %}
            {% if deans %}
            {% for dean in deans %}
            <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center transition hover:bg-gray-700 cursor-pointer"
                 onclick="confirmDeleteUser({{ dean.id }})">
                <div class="w-20 h-20 bg-white rounded-full mb-4"></div>
                <p class="text-white text-lg font-bold text-center">{{ dean.firstName }} {{ dean.lastName }}</p>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-gray-400 col-span-2">No Deans found for this college.</p>
            {% endif %}
        </div>

        <h3 class="text-2xl font-bold text-white mb-4">Teachers</h3>
        <div class="grid grid-cols-2 gap-6">
            {% set teachers = users | selectattr("userType", "equalto", "Teacher") | list %}
            {% if teachers %}
            {% for teacher in teachers %}
            <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center transition hover:bg-gray-700 cursor-pointer"
                 onclick="confirmDeleteUser({{ teacher.id }})">
                <div class="w-20 h-20 bg-white rounded-full mb-4"></div>
                <p class="text-white text-lg font-bold text-center">{{ teacher.firstName }} {{ teacher.lastName }}</p>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-gray-400 col-span-2">No Teachers found for this college.</p>
            {% endif %}
        </div>

        {% elif user.userType == 'Dean' %}
        <!-- Dean View: Show only Teachers in this college -->
        <h3 class="text-2xl font-bold text-white mb-4 mt-6">Teachers</h3>
        <div class="grid grid-cols-2 gap-6">
            {% set teachers = users | selectattr("userType", "equalto", "Teacher") | list %}
            {% if teachers %}
            {% for teacher in teachers %}
            <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center transition hover:bg-gray-700 cursor-pointer"
                 onclick="toggleTeacherActions('{{ teacher.uName }}')">
                <div class="w-20 h-20 bg-white rounded-full mb-4"></div>
                <p class="text-white text-lg font-bold text-center">{{ teacher.firstName }} {{ teacher.lastName }}</p>
                <div id="actions-{{ teacher.uName }}" class="hidden mt-4 flex gap-2">
                    {% if user.userType == 'Dean' %}
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
                            onclick="redirectToUploadHistory('{{ teacher.uName }}', '{{ college.college_acronym }}')">
                        Upload
                    </button>
                    {% endif %}
                    <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg"
                            onclick="openAnalysisModal('{{ teacher.uName }}')">
                        Analysis
                    </button>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-gray-400 col-span-2">No Teachers found for this college.</p>
            {% endif %}
        </div>

        {% elif user.userType == 'Curriculum Developer' %}
        <!-- Curriculum Developer View: Show only Teachers in this college -->
        <h3 class="text-2xl font-bold text-white mb-4 mt-6">Teachers</h3>
        <div class="grid grid-cols-2 gap-6">
            {% set teachers = users | selectattr("userType", "equalto", "Teacher") | list %}
            {% if teachers %}
            {% for teacher in teachers %}
            <div class="bg-gray-800 p-4 rounded-lg flex flex-col items-center transition hover:bg-gray-700 cursor-pointer"
                 onclick="toggleTeacherActions('{{ teacher.uName }}')">
                <div class="w-20 h-20 bg-white rounded-full mb-4"></div>
                <p class="text-white text-lg font-bold text-center">{{ teacher.firstName }} {{ teacher.lastName }}</p>
                <div id="actions-{{ teacher.uName }}" class="hidden mt-4 flex gap-2">
                    <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg"
                            onclick="openAnalysisModal('{{ teacher.uName }}')">
                        Analysis
                    </button>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-gray-400 col-span-2">No Teachers found for this college.</p>
            {% endif %}
        </div>
        {% else %}
        <script>
			if (!['admin', 'Dean', 'Curriculum Developer'].includes("{{ user.userType }}")) {
				window.location.href = "{{ url_for('dashboard') }}";
			}
        </script>
        {% endif %}
    </main>
</div>

<!-- Analysis Modal -->
<div id="analysisModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start p-4">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-3xl mt-4 overflow-y-auto">
        <h3 class="text-xl font-bold text-white mb-4">Analysis</h3>
        <canvas id="analysisChart"></canvas>
        <select id="fileSelect" class="mt-4 p-2 w-full bg-gray-700 text-white rounded-lg">
            <option value="overall">Overall</option> <!-- "Overall" option at the top -->
        </select>
        <div id="fileDetails" class="mt-4 text-white"></div>
        <div class="mt-4 flex justify-between">
            <button id="viewButton" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">View</button>
            <button onclick="closeAnalysisModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
  {% if user.userType == 'admin' %}
<script>
  function confirmDeleteUser(userId) {
    if (confirm("Are you sure you want to delete this account? This action cannot be undone.")) {
      let deleteUrl = "{{ url_for('delete_teacher', teacher_id=user.id) }}";
      deleteUrl = deleteUrl.replace('user_id_placeholder', userId);
      fetch(deleteUrl, { method: 'POST' })
        .then(response => {
          if (response.redirected) {
            window.location.href = response.url;
          } else {
            location.reload();
          }
        })
        .catch(error => {
          console.error("Error deleting account:", error);
        });
    }
  }
</script>

  {% elif user.userType == 'Dean' or 'Curriculum Developer' %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let analysisChartInstance = null;
    uname = "";

    function toggleTeacherActions(uName) {
        uname = uName;
        document.querySelectorAll('[id^="actions-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('actions-' + uName).classList.toggle('hidden');
    }

    function redirectToUploadHistory(uName, collegeAcronym) {
        window.location.href = "{{ url_for('uploadHistory') }}?teacher=" + encodeURIComponent(uName) + "&college=" + encodeURIComponent(collegeAcronym);
    }

    function openAnalysisModal(uName) {
        uname = uName;
        document.getElementById('analysisModal').classList.remove('hidden');

        // Clear previous options in the dropdown
        let fileSelect = document.getElementById('fileSelect');
        fileSelect.innerHTML = "<option value='overall'>Overall</option>"; // Add "Overall" option at the top

        fetch("{{ url_for('analysis') }}?teacher=" + encodeURIComponent(uname))
            .then(response => response.json())
            .then(data => {
                console.log("Received files:", data.files);

                if (!data.files || data.files.length === 0) {
                    document.getElementById('fileDetails').innerHTML = "<p>No uploads found for this teacher.</p>";
                    return;
                }

                // Populate the file dropdown with all available files
                data.files.forEach(file => {
                    let option = document.createElement("option");
                    option.value = file.filename;
                    option.textContent = file.filename;
                    fileSelect.appendChild(option);
                });

                // Default to the first file (which is "Overall")
                fileSelect.value = "overall";
                fileSelect.dispatchEvent(new Event('change')); // Trigger the chart update

                // Automatically load the overall chart
                loadChart(data, "overall");
            })
            .catch(error => console.error("Error fetching files:", error));
    }

    document.getElementById('viewButton').addEventListener('click', function () {
        const fileName = document.getElementById('fileSelect').value;

        fetch(`/analysis?teacher=${encodeURIComponent(uname)}&file_name=${fileName}`)
            .then(response => response.json())
            .then(data => {
                console.log("Analysis Data:", data);

                // Update the chart with the selected file or overall data
                loadChart(data, fileName);

                // Update the recommendation message
                document.getElementById('fileDetails').innerHTML = `<p>Recommendation: ${data.recommendation}</p>`;
            })
            .catch(error => console.error("Error fetching analysis data:", error));
    });

    function loadChart(data, fileName) {
        if (analysisChartInstance) {
            analysisChartInstance.destroy();
        }

        const ctx = document.getElementById('analysisChart').getContext('2d'); // Get canvas context

        if (fileName === "overall") {
        // --- OVERALL VIEW (LINE CHART) ---
            // Prepare the labels (files) and data
            const labels = data.files.map(file => file.filename);  // X-axis: filenames
            const positiveData = data.files.map(file => {
                if (!file.sentiment) {
                    console.warn(`Missing sentiment data for file: ${file.filename}`);
                    return 0;
                }
                // Ensure sentiment is parsed if it's a string
                const sentimentData = Array.isArray(file.sentiment) ? file.sentiment : JSON.parse(file.sentiment || "[]");
                return sentimentData.filter(s => s === "Positive").length;  // Y-axis: positive sentiment counts
            });
            const negativeData = data.files.map(file => {
                if (!file.sentiment) {
                    console.warn(`Missing sentiment data for file: ${file.filename}`);
                    return 0;
                }
                // Ensure sentiment is parsed if it's a string
                const sentimentData = Array.isArray(file.sentiment) ? file.sentiment : JSON.parse(file.sentiment || "[]");
                return sentimentData.filter(s => s === "Negative").length;  // Y-axis: negative sentiment counts
            });

            // Create a new chart with the files on the x-axis
            analysisChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,  // Files on the x-axis
                    datasets: [
                        {
                            label: 'Positive',
                            data: positiveData,  // Positive sentiment counts
                            borderColor: 'green',
                            fill: false,
                            pointStyle: 'circle',
                            pointRadius: 5
                        },
                        {
                            label: 'Negative',
                            data: negativeData,  // Negative sentiment counts
                            borderColor: 'red',
                            fill: false,
                            pointStyle: 'circle',
                            pointRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Sentiment Count'  // Label for the y-axis
                            },
                            ticks: {
                                stepSize: 1  // Ensure the y-axis has discrete steps
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Files'  // Label for the x-axis
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    return `${tooltipItem.dataset.label}: ${tooltipItem.raw} sentiments`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // --- SPECIFIC FILE VIEW (BAR CHART) ---
            const selectedFile = data.files.find(file => file.filename === fileName);
            if (!selectedFile) {
                console.error("File not found in dataset.");
                return;
            }

            const positiveCount = selectedFile.sentiment.filter(s => s === "Positive").length;
            const negativeCount = selectedFile.sentiment.filter(s => s === "Negative").length;

            analysisChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ["Positive", "Negative"],  // X-axis categories
                    datasets: [{
                        label: `Sentiment Breakdown for ${fileName}`,
                        data: [positiveCount, negativeCount],  // Y-axis values
                        backgroundColor: ['green', 'red']
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Count' },
                            ticks: { stepSize: 1 }
                        },
                        x: { title: { display: true, text: 'Sentiment Type' } }
                    }
                }
            });
        }
    }

    function closeAnalysisModal() {
        document.getElementById('analysisModal').classList.add('hidden');
    }
</script>
  {% endif %}
{% endblock %}
